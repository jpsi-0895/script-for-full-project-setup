#!/usr/bin/env bash
set -euo pipefail

# =======================================
# Laravel Backend Environment Setup Script
# Works on Ubuntu 20.04 / 22.04 / 24.04
# =======================================



PHP_VERSION="8.2"
PROJECT_DIR="/var/www/laravel-app"
LOG_FILE="/var/log/laravel-setup.log"

# --- Color codes ---
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

log() {
  echo -e "${YELLOW}ğŸ”¹ $1${NC}"
  echo "$(date +"%F %T") : $1" >> "$LOG_FILE"
}

success() {
  echo -e "${GREEN}âœ… $1${NC}"
  echo "$(date +"%F %T") : SUCCESS - $1" >> "$LOG_FILE"
}

error_exit() {
  echo -e "${RED}âŒ ERROR: $1${NC}"
  echo "$(date +"%F %T") : ERROR - $1" >> "$LOG_FILE"
  exit 1
}

echo -e "${GREEN}ğŸš€ Starting Laravel Backend Environment Setup...${NC}"
sudo apt update &>> "$LOG_FILE" || error_exit "Failed to update packages"

# --- Step 1: Basic Utilities ---
log "Installing core utilities..."
sudo apt install -y curl zip unzip git software-properties-common ca-certificates lsb-release apt-transport-https &>> "$LOG_FILE"

# --- Step 2: PHP Installation ---
log "Installing PHP ${PHP_VERSION} and extensions..."
sudo add-apt-repository ppa:ondrej/php -y &>> "$LOG_FILE"
sudo apt update -y &>> "$LOG_FILE"
sudo apt install -y php${PHP_VERSION} php${PHP_VERSION}-cli php${PHP_VERSION}-fpm \
php${PHP_VERSION}-common php${PHP_VERSION}-mysql php${PHP_VERSION}-xml \
php${PHP_VERSION}-mbstring php${PHP_VERSION}-curl php${PHP_VERSION}-zip \
php${PHP_VERSION}-bcmath php${PHP_VERSION}-intl php${PHP_VERSION}-gd php${PHP_VERSION}-tokenizer &>> "$LOG_FILE" \
  || error_exit "PHP installation failed"
success "PHP ${PHP_VERSION} installed."

# --- Step 3: MySQL Installation ---
log "Installing MySQL Server..."
sudo apt install -y mysql-server &>> "$LOG_FILE"
sudo systemctl enable mysql &>> "$LOG_FILE"
sudo systemctl start mysql &>> "$LOG_FILE"
success "MySQL installed and running."

# --- Step 4: Composer Installation ---
if ! command -v composer &> /dev/null; then
  log "Installing Composer..."
  curl -sS https://getcomposer.org/installer -o composer-setup.php
  sudo php composer-setup.php --install-dir=/usr/local/bin --filename=composer &>> "$LOG_FILE"
  rm composer-setup.php
  success "Composer installed."
else
  success "Composer already installed."
fi

# --- Step 5: Nginx Installation ---
log "Installing Nginx..."
sudo apt install -y nginx &>> "$LOG_FILE"
sudo systemctl enable nginx &>> "$LOG_FILE"
sudo systemctl start nginx &>> "$LOG_FILE"
success "Nginx installed and running."

# --- Step 6: Node.js Installation (optional) ---
if ! command -v node &> /dev/null; then
  log "Installing Node.js (LTS)..."
  curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash - &>> "$LOG_FILE"
  sudo apt install -y nodejs &>> "$LOG_FILE"
  success "Node.js installed."
else
  success "Node.js already installed."
fi





# --- Step 7: Version Summary ---
echo -e "\n${GREEN}=============================="
echo "ğŸ¯ Laravel Environment Versions"
echo "==============================${NC}"
php -v | head -n 1
composer -V
mysql --version
nginx -v 2>&1
node -v || echo "Node.js not installed"
npm -v || echo "npm not installed"
supervisorctl version
ufw status | grep "Status"

echo -e "\n${GREEN}ğŸ‰ Laravel Backend Setup Completed Successfully!${NC}"
echo -e "ğŸ“ Project Directory: ${YELLOW}${PROJECT_DIR}${NC}"
echo -e "ğŸªµ Setup Log File: ${YELLOW}${LOG_FILE}${NC}"
