#!/usr/bin/env bash
# Minimal Laravel environment setup
# PHP + MySQL + Composer + Clone Repo
# Clean version: NO logging, NO error-handling wrappers

set -euo pipefail  # Exit on error, undefined var, or pipe failure

# ---------------- CONFIG ----------------
PHP_VERSION="${1:-8.2}" # Default to PHP 8.2 if not provided

echo "===================================="
echo "ðŸ”§ Starting Laravel Environment Setup" 
echo "===================================="

# ---------------- UPDATE + BASICS ----------------
sudo apt update -y # Update package lists
sudo apt upgrade -y # Upgrade installed packages
sudo apt install -y software-properties-common apt-transport-https ca-certificates gnupg curl git # Basic tools

# ---------------- INSTALL PHP ----------------
sudo add-apt-repository ppa:ondrej/php -y # Add PHP PPA
sudo apt update -y # Update package lists again

sudo apt install -y \   # Install PHP and extensions
  php${PHP_VERSION} php${PHP_VERSION}-cli php${PHP_VERSION}-fpm \           # Install PHP-FPM
  php${PHP_VERSION}-common php${PHP_VERSION}-mysql php${PHP_VERSION}-xml \     # XML support
  php${PHP_VERSION}-mbstring php${PHP_VERSION}-curl php${PHP_VERSION}-zip \      # Common extensions
  php${PHP_VERSION}-bcmath php${PHP_VERSION}-intl php${PHP_VERSION}-gd \     # Additional extensions
  php${PHP_VERSION}-tokenizer || {       # Retry without tokenizer if it fails

  echo "Retrying PHP install without tokenizer..."         # Retry logic
  sudo apt install -y \
    php${PHP_VERSION} php${PHP_VERSION}-cli php${PHP_VERSION}-fpm \         # Install PHP-FPM
    php${PHP_VERSION}-common php${PHP_VERSION}-mysql php${PHP_VERSION}-xml \          # XML support
    php${PHP_VERSION}-mbstring php${PHP_VERSION}-curl php${PHP_VERSION}-zip \           # Common extensions
    php${PHP_VERSION}-bcmath php${PHP_VERSION}-intl php${PHP_VERSION}-gd     # Additional extensions
}

# Restart PHP-FPM if exists
if systemctl list-units | grep -q "php${PHP_VERSION}-fpm"; then   # Check if service exists
  sudo systemctl restart "php${PHP_VERSION}-fpm"   # Restart PHP-FPM
fi

# ---------------- INSTALL MYSQL ----------------
sudo apt install -y mysql-server           # Install MySQL server
sudo systemctl enable mysql          # Enable MySQL to start on boot 
sudo systemctl start mysql         # Start MySQL service

# ---------------- INSTALL COMPOSER ----------------
if ! command -v composer &>/dev/null; then         # Check if Composer is not installed
  curl -sS https://getcomposer.org/installer -o composer-setup.php      # Download Composer installer
  sudo php composer-setup.php --install-dir=/usr/local/bin --filename=composer     # Install Composer globally
  rm composer-setup.php        # Clean up installer
fi

# ---------------- CLONE GITHUB REPO ----------------
echo ""         ## New line for readability
read -p "Enter GitHub Repo URL: " REPO_URL  # Prompt for repo URL
[[ -z "$REPO_URL" ]] && { echo "Repo URL is required!"; exit 1; }  # Exit if empty

git clone "$REPO_URL"  # Clone the specified repo

# ======================================================
# SHOW INSTALLED VERSIONS & SERVICE STATUS
# ======================================================

echo ""
echo "===================================="
echo "ðŸ“Š INSTALLATION SUMMARY"
echo "===================================="

echo "âž¡ PHP Version:"  #   Display PHP version  
php -v | head -n 1   # Get first line of PHP version
echo ""  # New line for readability

echo "âž¡ PHP-FPM Service:"  # Display PHP-FPM service status
sudo systemctl status php${PHP_VERSION}-fpm --no-pager | head -n 5  # Get first 5 lines of status
echo ""   # New line for readability

echo "âž¡ MySQL Version:"  # Display MySQL version
mysql --version  # Get MySQL version
echo ""  # New line for readability

echo "âž¡ MySQL Service:"  # Display MySQL service status
sudo systemctl status mysql --no-pager | head -n 5  # Get first 5 lines of status
echo ""     # New line for readability

echo "âž¡ Composer Version:"     # Display Composer version
composer -V  # Get Composer version
echo ""   # New line for readability    

echo "âž¡ Git Version:"       # Display Git version
git --version               # Get Git version
echo ""                    # New line for readability

echo "===================================="
echo "ðŸŽ‰ Setup complete!"                               
echo "===================================="
