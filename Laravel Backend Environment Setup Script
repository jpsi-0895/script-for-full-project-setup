#!/usr/bin/env bash
# Minimal Laravel environment setup
# PHP + MySQL + Composer + Clone Repo
# Clean version: NO logging, NO error-handling wrappers

set -euo pipefail

# ---------------- CONFIG ----------------
PHP_VERSION="${1:-8.2}"

echo "===================================="
echo "ðŸ”§ Starting Laravel Environment Setup"
echo "===================================="

# ---------------- UPDATE + BASICS ----------------
sudo apt update -y
sudo apt install -y software-properties-common apt-transport-https ca-certificates gnupg curl git

# ---------------- INSTALL PHP ----------------
sudo add-apt-repository ppa:ondrej/php -y
sudo apt update -y

sudo apt install -y \
  php${PHP_VERSION} php${PHP_VERSION}-cli php${PHP_VERSION}-fpm \
  php${PHP_VERSION}-common php${PHP_VERSION}-mysql php${PHP_VERSION}-xml \
  php${PHP_VERSION}-mbstring php${PHP_VERSION}-curl php${PHP_VERSION}-zip \
  php${PHP_VERSION}-bcmath php${PHP_VERSION}-intl php${PHP_VERSION}-gd \
  php${PHP_VERSION}-tokenizer || {

  echo "Retrying PHP install without tokenizer..."
  sudo apt install -y \
    php${PHP_VERSION} php${PHP_VERSION}-cli php${PHP_VERSION}-fpm \
    php${PHP_VERSION}-common php${PHP_VERSION}-mysql php${PHP_VERSION}-xml \
    php${PHP_VERSION}-mbstring php${PHP_VERSION}-curl php${PHP_VERSION}-zip \
    php${PHP_VERSION}-bcmath php${PHP_VERSION}-intl php${PHP_VERSION}-gd
}

# Restart PHP-FPM if exists
if systemctl list-units | grep -q "php${PHP_VERSION}-fpm"; then
  sudo systemctl restart "php${PHP_VERSION}-fpm"
fi

# ---------------- INSTALL MYSQL ----------------
sudo apt install -y mysql-server
sudo systemctl enable mysql
sudo systemctl start mysql

# ---------------- INSTALL COMPOSER ----------------
if ! command -v composer &>/dev/null; then
  curl -sS https://getcomposer.org/installer -o composer-setup.php
  sudo php composer-setup.php --install-dir=/usr/local/bin --filename=composer
  rm composer-setup.php
fi

# ---------------- CLONE GITHUB REPO ----------------
echo ""
read -p "Enter GitHub Repo URL: " REPO_URL
[[ -z "$REPO_URL" ]] && { echo "Repo URL is required!"; exit 1; }

git clone "$REPO_URL"

# ======================================================
# SHOW INSTALLED VERSIONS & SERVICE STATUS
# ======================================================

echo ""
echo "===================================="
echo "ðŸ“Š INSTALLATION SUMMARY"
echo "===================================="

echo "âž¡ PHP Version:"
php -v | head -n 1
echo ""

echo "âž¡ PHP-FPM Service:"
sudo systemctl status php${PHP_VERSION}-fpm --no-pager | head -n 5
echo ""

echo "âž¡ MySQL Version:"
mysql --version
echo ""

echo "âž¡ MySQL Service:"
sudo systemctl status mysql --no-pager | head -n 5
echo ""

echo "âž¡ Composer Version:"
composer -V
echo ""

echo "âž¡ Git Version:"
git --version
echo ""

echo "===================================="
echo "ðŸŽ‰ Setup complete!"
echo "===================================="
